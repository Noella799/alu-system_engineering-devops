#!/usr/bin/env bash
# Install Nginx and ensure all HTTP responses include X-Served-By=<hostname> (Ubuntu 16.04-safe, idempotent)
# shellcheck disable=SC2154

set -euo pipefail
export DEBIAN_FRONTEND=noninteractive

apt-get update -y
apt-get install -y nginx

# Backup nginx.conf once
if [ ! -f /etc/nginx/nginx.conf.bak ]; then
  cp -p /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak
fi

# If the header is not already configured at http{} scope, inject it just before the closing brace of http{}
if ! grep -qE '^\s*add_header\s+X-Served-By\s+\$hostname' /etc/nginx/nginx.conf; then
  awk '
    BEGIN{in_http=0; done=0}
    /http[[:space:]]*\{/ {in_http=1}
    {
      if (in_http && !done && /^\}/) {
        print "    add_header X-Served-By $hostname always;";
        done=1
      }
      print
      if (in_http && /^\}/) {in_http=0}
    }
  ' /etc/nginx/nginx.conf > /etc/nginx/nginx.conf.new
  mv /etc/nginx/nginx.conf.new /etc/nginx/nginx.conf
fi

# Validate and reload Nginx
nginx -t
if command -v systemctl >/dev/null 2>&1; then
  systemctl reload nginx
else
  service nginx reload
fi

